<div style=" width:100%; height:1px; clear:both;">.</div>
<div style="float: left">
    <div id = "lefttable">
        <table id="headercontrol" >
            <tr id="today">
                <td>
                    <?=$langs->trans('TitleToday')?>
                </td>
                <td class="autoinsert">
                    <?=date('d.m.Y')?>
                </td>
                <td>
                    Структурний підрозділ
                </td>
                <td class="autoinsert">
                    <?=$subdivision?>
                </td>
            </tr>
            <tr id="worker">
                <td>
                    <?=$langs->trans('worker')?>
                </td>
                <td class="autoinsert">
                    <?echo $user->lastname?>
                </td>
                <td>

                </td>
                <td class="autoinsert">

                </td>
            </tr>
        </table>
        </br>
    </div>

    <div>
        <table cellspacing="1" class="WidthScroll">
              <thead id="theadDay">
                <tr class="multiple_header_table">
                    <th rowspan="4" style="width: 110px;">Область</th>
                    <th rowspan="4" style="width: 175px;">Район</th>
                    <th rowspan="4" style="width: 33px;">&nbsp;</th>
                    <th colspan="9">% виконання запланованого по факту</th>
                    <th colspan="9">минуле (факт)</th>
                    <th rowspan="4" class="small_size" style="width: 55px;writing-mode:tb-lr;">кільк. простроч.</th>
                    <th colspan="9">майбутнє (план)</th>
                </tr>
                <tr class="multiple_header_table">
                    <!--% виконання запланованого по факту-->
                    <th class="small_size" style="width: 35px">за місяць</th>
                    <th class="small_size" style="width: 35px">за 7 днів</th>
                    <th class="small_size" style="width: 35px">за 6 днів</th>
                    <th class="small_size" style="width: 35px">за 5 днів</th>
                    <th class="small_size" style="width: 35px">за 4 днів</th>
                    <th class="small_size" style="width: 35px">за 3 дня</th>
                    <th class="small_size" style="width: 35px">за 2 дня</th>
                    <th class="small_size" style="width: 35px">за 1 день</th>
                    <th class="small_size" style="width: 35px">сього- дні</th>
                    <!--минуле (факт)-->
                    <th class="small_size" style="width: 35px">за місяць</th>
                    <th class="small_size" style="width: 35px">за 7 днів</th>
                    <th class="small_size" style="width: 35px">за 6 днів</th>
                    <th class="small_size" style="width: 35px">за 5 днів</th>
                    <th class="small_size" style="width: 35px">за 4 днів</th>
                    <th class="small_size" style="width: 35px">за 3 дня</th>
                    <th class="small_size" style="width: 35px">за 2 дня</th>
                    <th class="small_size" style="width: 35px">за 1 день</th>
                    <th class="small_size" style="width: 35px">сього- дні</th>
                    <!--майбутнє (план)-->
                    <th class="small_size" style="width: 35px">сього- дні</th>
                    <th class="small_size" style="width: 35px">за 1 день</th>
                    <th class="small_size" style="width: 35px">за 2 дня</th>
                    <th class="small_size" style="width: 35px">за 3 дня</th>
                    <th class="small_size" style="width: 35px">за 4 днів</th>
                    <th class="small_size" style="width: 35px">за 5 днів</th>
                    <th class="small_size" style="width: 35px">за 6 днів</th>
                    <th class="small_size" style="width: 35px">за 7 днів</th>
                    <th class="small_size" style="width: 35px">за місяць</th>
                </tr>
                <tr class="multiple_header_table">
                    <!--% виконання запланованого по факту-->
                    <th class="small_size"></th>
                    <th class="small_size"></th>
                    <th class="small_size"><?=$langs->trans('ShortDay'.date('w', mktime(0,0,0, date('m'), date('d')-6, date('Y'))))?></th>
                    <th class="small_size"><?=$langs->trans('ShortDay'.date('w', mktime(0,0,0, date('m'), date('d')-5, date('Y'))))?></th>
                    <th class="small_size"><?=$langs->trans('ShortDay'.date('w', mktime(0,0,0, date('m'), date('d')-4, date('Y'))))?></th>
                    <th class="small_size"><?=$langs->trans('ShortDay'.date('w', mktime(0,0,0, date('m'), date('d')-3, date('Y'))))?></th>
                    <th class="small_size"><?=$langs->trans('ShortDay'.date('w', mktime(0,0,0, date('m'), date('d')-2, date('Y'))))?></th>
                    <th class="small_size"><?=$langs->trans('ShortDay'.date('w', mktime(0,0,0, date('m'), date('d')-1, date('Y'))))?></th>
                    <th class="small_size"><?=$langs->trans('ShortDay'.date('w'))?></th>
                    <!--минуле (факт)-->
                    <th class="small_size"></th>
                    <th class="small_size"></th>
                    <th class="small_size"><?=$langs->trans('ShortDay'.date('w', mktime(0,0,0, date('m'), date('d')-6, date('Y'))))?></th>
                    <th class="small_size"><?=$langs->trans('ShortDay'.date('w', mktime(0,0,0, date('m'), date('d')-5, date('Y'))))?></th>
                    <th class="small_size"><?=$langs->trans('ShortDay'.date('w', mktime(0,0,0, date('m'), date('d')-4, date('Y'))))?></th>
                    <th class="small_size"><?=$langs->trans('ShortDay'.date('w', mktime(0,0,0, date('m'), date('d')-3, date('Y'))))?></th>
                    <th class="small_size"><?=$langs->trans('ShortDay'.date('w', mktime(0,0,0, date('m'), date('d')-2, date('Y'))))?></th>
                    <th class="small_size"><?=$langs->trans('ShortDay'.date('w', mktime(0,0,0, date('m'), date('d')-1, date('Y'))))?></th>
                    <th class="small_size"><?=$langs->trans('ShortDay'.date('w'))?></th>
                    <!--майбутнє (план)-->
                    <th class="small_size"><?=$langs->trans('ShortDay'.date('w'))?></th>
                    <th class="small_size"><?=$langs->trans('ShortDay'.date('w', mktime(0,0,0, date('m'), date('d')+1, date('Y'))))?></th>
                    <th class="small_size"><?=$langs->trans('ShortDay'.date('w', mktime(0,0,0, date('m'), date('d')+2, date('Y'))))?></th>
                    <th class="small_size"><?=$langs->trans('ShortDay'.date('w', mktime(0,0,0, date('m'), date('d')+3, date('Y'))))?></th>
                    <th class="small_size"><?=$langs->trans('ShortDay'.date('w', mktime(0,0,0, date('m'), date('d')+4, date('Y'))))?></th>
                    <th class="small_size"><?=$langs->trans('ShortDay'.date('w', mktime(0,0,0, date('m'), date('d')+5, date('Y'))))?></th>
                    <th class="small_size"><?=$langs->trans('ShortDay'.date('w', mktime(0,0,0, date('m'), date('d')+6, date('Y'))))?></th>
                    <th class="small_size"></th>
                    <th class="small_size"></th>
                </tr>
                <tr class="multiple_header_table">
                    <!--% виконання запланованого по факту-->
                    <th class="small_size"></th>
                    <th class="small_size"></th>
                    <th class="small_size"><?=date('d.m', (time()+3600*24*-6))?></th>
                    <th class="small_size"><?=date('d.m', (time()+3600*24*-5))?></th>
                    <th class="small_size"><?=date('d.m', (time()+3600*24*-4))?></th>
                    <th class="small_size"><?=date('d.m', (time()+3600*24*-3))?></th>
                    <th class="small_size"><?=date('d.m', (time()+3600*24*-2))?></th>
                    <th class="small_size"><?=date('d.m', (time()+3600*24*-1))?></th>
                    <th class="small_size"><?=date('d.m')?></th>
                    <!--минуле (факт)-->
                    <th class="small_size"></th>
                    <th class="small_size"></th>
                    <th class="small_size"><?=date('d.m', (time()+3600*24*-6))?></th>
                    <th class="small_size"><?=date('d.m', (time()+3600*24*-5))?></th>
                    <th class="small_size"><?=date('d.m', (time()+3600*24*-4))?></th>
                    <th class="small_size"><?=date('d.m', (time()+3600*24*-3))?></th>
                    <th class="small_size"><?=date('d.m', (time()+3600*24*-2))?></th>
                    <th class="small_size"><?=date('d.m', (time()+3600*24*-1))?></th>
                    <th class="small_size"><?=date('d.m')?></th>
                    <!--майбутнє (план)-->
                    <th class="small_size"><?=date('d.m')?></th>
                    <th class="small_size"><?=date('d.m', (time()+3600*24*1))?></th>
                    <th class="small_size"><?=date('d.m', (time()+3600*24*2))?></th>
                    <th class="small_size"><?=date('d.m', (time()+3600*24*3))?></th>
                    <th class="small_size"><?=date('d.m', (time()+3600*24*4))?></th>
                    <th class="small_size"><?=date('d.m', (time()+3600*24*5))?></th>
                    <th class="small_size"><?=date('d.m', (time()+3600*24*6))?></th>
                    <th class="small_size"></th>
                    <th class="small_size"></th>
                </tr>
            </thead>

            <?=$table?>

        </table>
    </div>
</div>


<script>
    $(document).ready(function(){
        $('#reference_body').attr('height', window.innerHeight - 370);

//        if('<?=$conf->browser->name?>' =='firefox')
//        {
//            $('#reference_body').width(width-110);
//        }else if('<?=$conf->browser->name?>' =='chrome')
//            $('#reference_body').width(width-90);
        $('#popupmenu').offset({top:550, left:-250});
        var param = {
            action:'ShowTable'
        }
        $.ajax({
            data:param,
            cache:false,
            success:function(html){
                $('#loading_img').hide();
                document.getElementById('theadDay').insertAdjacentHTML('afterend', html);
                SetTheadColumnWidth();
                var width = $('#reference_body').width();
                $('#reference_body').width(width+20);
            }
        })
    })

    function ShowTask(object){
        var td = $('#'+object.target.id);
        if(object.target.id.substr(0, 'current'.length)=='current'||
                object.target.id.substr(0, 'global'.length)=='global'||
                        object.target.id.substr(0, 'total'.length)=='total'
        ){}else
            return;
        $.ajax({
            url:'/dolibarr/htdocs/day_plan.php?action=getdateaction&type_action='+object.target.id,
            cache:false,
            success:function(html){
                if(td.text() == '1'){
                    location.href = 'http://'+location.hostname+'/dolibarr/htdocs/hourly_plan.php?idmenu=10420&mainmenu=hourly_plan&leftmenu=&date='+html;
                    console.log(html);
                }else {
                    var tbody = $('table.setdate').find('tbody');
                    tbody[0].innerHTML = html;
                    $("#popupmenu").attr('type_action', object.target.id);
                    $("#popupmenu").show();
                    $("#popupmenu").offset({
                        top: td.offset().top - 50,
                        left: td.offset().left - $('#reference_body').width()
                    });
                }
            }
        })


    }
//    function SetTheadColumnWidth(){
//        var tr = $('#reference_body').find('tr')[$('#reference_body').find('tr').length-1];
//        var td = tr.getElementsByTagName('td');
////        td[0].outerWidth =
//        var thead = $('thead').find('tr')[0];
//        var th = thead.getElementsByTagName('th');
//        td[0].style.minWidth = th[0].clientWidth+th[1].clientWidth-1+'px';
//        td[1].style.minWidth = th[2].clientWidth-1+'px';
//        td[1].style.maxWidth = th[2].clientWidth-1+'px';
//
//        thead = $('thead').find('tr')[1];
//        th = thead.getElementsByTagName('th');
//        for(var c = 2; c<=20; c++){
//            td[c].style.minWidth = th[c-2].clientWidth-2+'px';
//            td[c].style.maxWidth = th[c-2].clientWidth-2+'px';
////            console.log(th[c-2]);
//        }
//        thead = $('thead').find('tr')[0];
//        th = thead.getElementsByTagName('th');
//        td[20].style.minWidth = th[5].clientWidth-2+'px';
//        td[20].style.maxWidth = th[5].clientWidth-2+'px';
//        thead = $('thead').find('tr')[1];
//        th = thead.getElementsByTagName('th');
//        for(var c = 21; c<=29; c++){
//            td[c].style.minWidth = th[c-3].clientWidth-2+'px';
//            td[c].style.maxWidth = th[c-3].clientWidth-2+'px';
//            console.log(td[c], th[c-3]);
//        }
//    }
    function setdate(id){
        location.href = 'http://'+location.hostname+'/dolibarr/htdocs/hourly_plan.php?idmenu=10420&mainmenu=hourly_plan&leftmenu=&date='+$('#'+id).text();
    }
//    function strpos( haystack, needle, offset){ // Find position of first occurrence of a string
//        var i = haystack.indexOf( needle, offset ); // returns -1
//        return i >= 0 ? i : false;
//    }

    function ShowActionsByUsers(id, typeaction, alias){
        console.log('imgLnAC_CUSTsale1',typeaction,alias,id);
//        var btn = document.getElementById('btnSub'+typeaction+id);
//
////        return;
//        var img = document.getElementById('imgSub'+typeaction+id);
        var img;
        var btn;
        if(alias === undefined || alias.length == 0) {
            img = $('#imgSub'+typeaction+id);
            btn = $('#btnSub'+typeaction+id);
        }else {
            img = $('#imgLn' + typeaction + alias + id);
            btn = $('#btnLn' + typeaction + alias + id);
        }
        var tr_item = btn.parent().parent();
        img = document.getElementById(img.attr('id'));
        tr_item = document.getElementById(tr_item.attr('id'));
//        console.log(tr_item, img, btn);
//        return;
//        var img = btn.getElementsByTagName('img')[0];
        var show = img.src.substr(img.src.length-('1downarrow.png').length) == '1downarrow.png';
        if(show)
            img.src = img.src.substr(0, img.src.length-('1downarrow.png').length)+'1uparrow.png';
        else
            img.src = img.src.substr(0, img.src.length-('1uparrow.png').length)+'1downarrow.png';
        var code = '';
        var responding = '';
        var subdiv_id = '';
        switch(typeaction){
            case 'AllTask':{
                code = 'AllTask';
                responding='';
            }break;
            case 'AC_GLOBAL':{
                code = "'AC_GLOBAL'";
                responding='';
            }break;
            case 'AC_CURRENT':{
                code = "'AC_CURRENT'";
                responding='';
            }break;
            case 'AC_CUST':{
                code = "'AC_CUST'";
                responding='';
            }break;
            case 'DirecorsAllTask':{
                code = 'all';
                responding=10;
            }break;

        }
        if(show) {
            console.log($('.'+typeaction+'_'+id).length);

            if($('.'+typeaction+'_'+id).length == 0) {
//                var tr_item = btn.parentNode.parentNode;
                var className = tr_item.className;
                className = className.replace('impair ', '');
                className = className.replace('pair ', '');
                className = className.replace('userlist ', '');
                className = $.trim(className);
                var link = '/dolibarr/htdocs/responsibility/gen_dir/day_plan.php?action=getUsersTask&code='+code+'&classname='+className+' '+ id+'&responding='+alias+'&subdiv_id='+id;

//                console.log(link);
//                return;
                $('#loading_img').show();
                $.ajax({
                    url: link,
                    cache: false,
                    success: function (html) {
//                        console.log(html);
                        tr_item.insertAdjacentHTML('afterend', html);
                        $('#loading_img').hide();

//                        soundPlay();
                    }
                })
            }else{
//                var tr_item = document.getElementsByClassName(id);
//                for(var i=0; i<tr_item.length; i++) {
//                    console.log(tr_item[i].className.substr(tr_item[i].className.length-id.length), id);
//                    if(tr_item[i].className.substr(tr_item[i].className.length-id.length) == id || tr_item[i].className.substr(tr_item[i].className.length-(id+' userlist').length) == id+' userlist')
//                        $('#' + tr_item[i].id).show();
//                }
                $('.'+typeaction+'_'+id).show();
            }
        }else{
            $('.'+typeaction+'_'+id).hide();
            img.src = '/dolibarr/htdocs/theme/eldy/img/1downarrow.png';
            var tr_item = document.getElementsByClassName(id);
            for(var i=0; i<tr_item.length; i++) {
                var img = tr_item[i].getElementsByTagName('img');
//                console.log(img.length);
                if(img.length>0)
                    img[0].src = '/dolibarr/htdocs/theme/eldy/img/1downarrow.png';
//                if(tr_item[i].className.substr(tr_item[i].className.length-id.length) != id) {
//                    console.log(tr_item[i].id);
//                    $('#' + tr_item[i].id).hide();
//                }
            }
        }
    }
    function ShowLinectiveTask(id, typeaction){
//        console.log(typeaction);
//        return;

        var btn = document.getElementById('btnSub'+typeaction+id);
        var img = document.getElementById('imgSub'+typeaction+id);
        var show = img.src.substr(img.src.length-('1downarrow.png').length) == '1downarrow.png';
        if(show)
            img.src = img.src.substr(0, img.src.length-('1downarrow.png').length)+'1uparrow.png';
        else
            img.src = img.src.substr(0, img.src.length-('1uparrow.png').length)+'1downarrow.png';
        var code = '';
        var responding = '';
        var subdiv_id = '';
        switch(typeaction){
            case 'AllTask':{
                code = 'all';
                responding='';
            }break;
            case 'AC_GLOBAL':{
                code = "'AC_GLOBAL'";
                responding='';
            }break;
            case 'AC_CURRENT':{
                code = "'AC_CURRENT'";
                responding='';
            }break;
            case 'AC_CUST':{
                code = "'AC_CUST'";
                responding='';
            }break;
            case 'DirecorsAllTask':{
                code = 'all';
                responding=10;
            }break;

        }
        if(show) {
            console.log(id);
            if($('.lineactive_'+id).length == 0) {
                var tr_item = btn.parentNode.parentNode;
                var className = tr_item.className;
                className = className.replace('impair ', '');
                className = className.replace('pair ', '');
                className = $.trim(className);
                var link = '/dolibarr/htdocs/responsibility/gen_dir/day_plan.php?action=getLineActiveTask&code='+code+'&classname='+className+' '+ id+'&responding='+responding+'&subdiv_id='+id;
//                console.log(link);
//                return;
                $('#loading_img').show();
                $.ajax({
                    url: link,
                    cache: false,
                    success: function (html) {
//                        console.log(html);
                        tr_item.insertAdjacentHTML('afterend', html);
                        $('#loading_img').hide();
                    }
                })
            }else{
//                var tr_item = document.getElementsByClassName(id);
//                for(var i=0; i<tr_item.length; i++) {
//                    console.log(tr_item[i].className.substr(tr_item[i].className.length-id.length), id);
//                    if(tr_item[i].className.substr(tr_item[i].className.length-id.length) == id || tr_item[i].className.substr(tr_item[i].className.length-(id+' userlist').length) == id+' userlist')
//                        $('#' + tr_item[i].id).show();
//                }
                $('.'+id).show();
            }
        }else{
            $('.lineactive_'+id).hide();
            var tr_item = document.getElementsByClassName(id);
            for(var i=0; i<tr_item.length; i++) {
                var img = tr_item[i].getElementsByTagName('img');
//                console.log(img.length);
                if(img.length>0)
                    img[0].src = '/dolibarr/htdocs/theme/eldy/img/1downarrow.png';
//                if(tr_item[i].className.substr(tr_item[i].className.length-id.length) != id) {
//                    console.log(tr_item[i].id);
//                    $('#' + tr_item[i].id).hide();
//                }
            }

        }
    }
    function ShowAllTask(id){
        var btn = document.getElementById('btn'+id);
        var img = document.getElementById('img'+id);
        var show = img.src.substr(img.src.length-('1downarrow.png').length) == '1downarrow.png';
        if(show)
            img.src = img.src.substr(0, img.src.length-('1downarrow.png').length)+'1uparrow.png';
        else
            img.src = img.src.substr(0, img.src.length-('1uparrow.png').length)+'1downarrow.png';
        var code = '';
        var responding = '';
        var subdiv_id = '';
        switch(id){
            case 'AllTask':{
                code = 'all';
                responding='';
            }break;
            case 'AC_GLOBAL':{
                code = "'AC_GLOBAL'";
                responding='';
            }break;
            case 'AC_CURRENT':{
                code = "'AC_CURRENT'";
                responding='';
            }break;
            case 'AC_CUST':{
                code = "'AC_CUST'";
                responding='';
            }break;
            case 'DirecorsAllTask':{
                code = 'all';
                responding=10;
            }break;
            default:{
                console.log(id, strpos(id, 'subdiv_'));
                if(id.substr(0, 'subdiv_'.length) == 'subdiv_'){
                    var subdiv_id = 0;
                    var kindtask = '';
                    for(var i = 'subdiv_'.length; i<=id.length; i++){
                        if(!$.isNumeric(id.substr(i,1))){
                            subdiv_id = id.substr('subdiv_'.length, i-'subdiv_'.length);
                            kindtask = id.substr(i);
                            console.log(subdiv_id, kindtask);
                            break;
                        }
                    }
                    console.log(kindtask);
                    switch(kindtask){
                        case 'AllTask':{
                            code = 'all';
                        }break;
                        case 'GlobalTask':{
                            code = "'AC_GLOBAL'";
                        }break;
                        case 'CurrentTask':{
                            code = "'AC_CURRENT'";
                        }break;
                        case 'LineActiveTask':{
                            code = "'AC_TEL','AC_FAX','AC_EMAIL','AC_RDV','AC_INT','AC_OTH','AC_DEP'";
                        }break;
                    }
                    console.log(code);
                }
            }
        }
        if(show) {
            console.log(id);
            if($('.'+id).length == 0) {
//                createNewForm('popupmenu','waitForm');
//                $('#waitForm').show();
                var tr_item = btn.parentNode.parentNode;
                var className = tr_item.className;
                className = className.replace('impair ', '');
                className = className.replace('pair ', '');
                className = $.trim(className);
                var link = '/dolibarr/htdocs/responsibility/gen_dir/day_plan.php?action=gettask&code='+code+'&classname='+className+' '+ id+'&responding='+responding+'&subdiv_id='+subdiv_id;
//                console.log(link);
//                return;
                $('#loading_img').show();
                $.ajax({
                    url: link,
                    cache: false,
                    success: function (html) {
//                        console.log(html);
                        tr_item.insertAdjacentHTML('afterend', html);
                        $('#loading_img').hide();
                    }
                })
            }else{
//                var tr_item = document.getElementsByClassName(id);
//                for(var i=0; i<tr_item.length; i++) {
//                    console.log(tr_item[i].className.substr(tr_item[i].className.length-id.length), id);
//                    if(tr_item[i].className.substr(tr_item[i].className.length-id.length) == id || tr_item[i].className.substr(tr_item[i].className.length-(id+' userlist').length) == id+' userlist')
//                        $('#' + tr_item[i].id).show();
//                }
                $('.'+id).show();
            }
        }else{
            $('.'+id).hide();
            var tr_item = document.getElementsByClassName(id);
            for(var i=0; i<tr_item.length; i++) {
                $('#'+tr_item[i].id).removeClass('AC_CUST');
                var img = tr_item[i].getElementsByTagName('img');
//                console.log(img.length);
                if(img.length>0)
                    img[0].src = '/dolibarr/htdocs/theme/eldy/img/1downarrow.png';
//                if(tr_item[i].className.substr(tr_item[i].className.length-id.length) != id) {
//                    console.log(tr_item[i].id);
//                    $('#' + tr_item[i].id).hide();
//                }
            }

        }
    }
</script>