<div style=" width:100%; height:1px; clear:both;">.</div>
<div style="float: left">
    <div id = "lefttable">
        <table id="headercontrol" >
            <tr id="today">
                <td>
                    <?=$langs->trans('TitleToday')?>
                </td>
                <td class="autoinsert">
                    <?=date('d.m.Y')?>
                </td>
                <td>
                    Структурний підрозділ
                </td>
                <td class="autoinsert">
                    <?=$subdivision?>
                </td>
            </tr>
            <tr id="worker">
                <td>
                    <?=$langs->trans('worker')?>
                </td>
                <td class="autoinsert">
                    <?echo $user->lastname?>
                </td>
                <td>

                </td>
                <td class="autoinsert">

                </td>
            </tr>
        </table>
        </br>
    </div>
    <!--<button onclick="RefreshData();">Оновити дані</button>-->
    <div>
        <table cellspacing="1" class="WidthScroll">
              <thead>
                <tr class="multiple_header_table">
                    <th rowspan="4" style="width: 110px;">Область</th>
                    <th rowspan="4" style="width: 175px;">Район</th>
                    <th rowspan="4" style="width: 33px;">&nbsp;</th>
                    <th colspan="9">% виконання запланованого по факту</th>
                    <th colspan="9">минуле (факт)</th>
                    <th rowspan="4" class="small_size" style="width: 55px;writing-mode:tb-lr;">кільк. простроч.</th>
                    <th colspan="9">майбутнє (план)</th>
                </tr>
                <tr class="multiple_header_table">
                    <!--% виконання запланованого по факту-->
                    <th class="small_size" style="width: 35px">за місяць</th>
                    <th class="small_size" style="width: 35px">за 7 днів</th>
                    <th class="small_size" style="width: 35px">за 6 днів</th>
                    <th class="small_size" style="width: 35px">за 5 днів</th>
                    <th class="small_size" style="width: 35px">за 4 днів</th>
                    <th class="small_size" style="width: 35px">за 3 дня</th>
                    <th class="small_size" style="width: 35px">за 2 дня</th>
                    <th class="small_size" style="width: 35px">за 1 день</th>
                    <th class="small_size" style="width: 35px">сього- дні</th>
                    <!--минуле (факт)-->
                    <th class="small_size" style="width: 35px">за місяць</th>
                    <th class="small_size" style="width: 35px">за 7 днів</th>
                    <th class="small_size" style="width: 35px">за 6 днів</th>
                    <th class="small_size" style="width: 35px">за 5 днів</th>
                    <th class="small_size" style="width: 35px">за 4 днів</th>
                    <th class="small_size" style="width: 35px">за 3 дня</th>
                    <th class="small_size" style="width: 35px">за 2 дня</th>
                    <th class="small_size" style="width: 35px">за 1 день</th>
                    <th class="small_size" style="width: 35px">сього- дні</th>
                    <!--майбутнє (план)-->
                    <th class="small_size" style="width: 35px">сього- дні</th>
                    <th class="small_size" style="width: 35px">за 1 день</th>
                    <th class="small_size" style="width: 35px">за 2 дня</th>
                    <th class="small_size" style="width: 35px">за 3 дня</th>
                    <th class="small_size" style="width: 35px">за 4 днів</th>
                    <th class="small_size" style="width: 35px">за 5 днів</th>
                    <th class="small_size" style="width: 35px">за 6 днів</th>
                    <th class="small_size" style="width: 35px">за 7 днів</th>
                    <th class="small_size" style="width: 35px">за місяць</th>
                </tr>
                <tr class="multiple_header_table">
                    <!--% виконання запланованого по факту-->
                    <th class="small_size"></th>
                    <th class="small_size"></th>
                    <th class="small_size"><?=$langs->trans('ShortDay'.date('w', mktime(0,0,0, date('m'), date('d')-6, date('Y'))))?></th>
                    <th class="small_size"><?=$langs->trans('ShortDay'.date('w', mktime(0,0,0, date('m'), date('d')-5, date('Y'))))?></th>
                    <th class="small_size"><?=$langs->trans('ShortDay'.date('w', mktime(0,0,0, date('m'), date('d')-4, date('Y'))))?></th>
                    <th class="small_size"><?=$langs->trans('ShortDay'.date('w', mktime(0,0,0, date('m'), date('d')-3, date('Y'))))?></th>
                    <th class="small_size"><?=$langs->trans('ShortDay'.date('w', mktime(0,0,0, date('m'), date('d')-2, date('Y'))))?></th>
                    <th class="small_size"><?=$langs->trans('ShortDay'.date('w', mktime(0,0,0, date('m'), date('d')-1, date('Y'))))?></th>
                    <th class="small_size"><?=$langs->trans('ShortDay'.date('w'))?></th>
                    <!--минуле (факт)-->
                    <th class="small_size"></th>
                    <th class="small_size"></th>
                    <th class="small_size"><?=$langs->trans('ShortDay'.date('w', mktime(0,0,0, date('m'), date('d')-6, date('Y'))))?></th>
                    <th class="small_size"><?=$langs->trans('ShortDay'.date('w', mktime(0,0,0, date('m'), date('d')-5, date('Y'))))?></th>
                    <th class="small_size"><?=$langs->trans('ShortDay'.date('w', mktime(0,0,0, date('m'), date('d')-4, date('Y'))))?></th>
                    <th class="small_size"><?=$langs->trans('ShortDay'.date('w', mktime(0,0,0, date('m'), date('d')-3, date('Y'))))?></th>
                    <th class="small_size"><?=$langs->trans('ShortDay'.date('w', mktime(0,0,0, date('m'), date('d')-2, date('Y'))))?></th>
                    <th class="small_size"><?=$langs->trans('ShortDay'.date('w', mktime(0,0,0, date('m'), date('d')-1, date('Y'))))?></th>
                    <th class="small_size"><?=$langs->trans('ShortDay'.date('w'))?></th>
                    <!--майбутнє (план)-->
                    <th class="small_size"><?=$langs->trans('ShortDay'.date('w'))?></th>
                    <th class="small_size"><?=$langs->trans('ShortDay'.date('w', mktime(0,0,0, date('m'), date('d')+1, date('Y'))))?></th>
                    <th class="small_size"><?=$langs->trans('ShortDay'.date('w', mktime(0,0,0, date('m'), date('d')+2, date('Y'))))?></th>
                    <th class="small_size"><?=$langs->trans('ShortDay'.date('w', mktime(0,0,0, date('m'), date('d')+3, date('Y'))))?></th>
                    <th class="small_size"><?=$langs->trans('ShortDay'.date('w', mktime(0,0,0, date('m'), date('d')+4, date('Y'))))?></th>
                    <th class="small_size"><?=$langs->trans('ShortDay'.date('w', mktime(0,0,0, date('m'), date('d')+5, date('Y'))))?></th>
                    <th class="small_size"><?=$langs->trans('ShortDay'.date('w', mktime(0,0,0, date('m'), date('d')+6, date('Y'))))?></th>
                    <th class="small_size"></th>
                    <th class="small_size"></th>
                </tr>
                <tr class="multiple_header_table">
                    <!--% виконання запланованого по факту-->
                    <th class="small_size"></th>
                    <th class="small_size"></th>
                    <th class="small_size"><?=date('d.m', (time()+3600*24*-6))?></th>
                    <th class="small_size"><?=date('d.m', (time()+3600*24*-5))?></th>
                    <th class="small_size"><?=date('d.m', (time()+3600*24*-4))?></th>
                    <th class="small_size"><?=date('d.m', (time()+3600*24*-3))?></th>
                    <th class="small_size"><?=date('d.m', (time()+3600*24*-2))?></th>
                    <th class="small_size"><?=date('d.m', (time()+3600*24*-1))?></th>
                    <th class="small_size"><?=date('d.m')?></th>
                    <!--минуле (факт)-->
                    <th class="small_size"></th>
                    <th class="small_size"></th>
                    <th class="small_size"><?=date('d.m', (time()+3600*24*-6))?></th>
                    <th class="small_size"><?=date('d.m', (time()+3600*24*-5))?></th>
                    <th class="small_size"><?=date('d.m', (time()+3600*24*-4))?></th>
                    <th class="small_size"><?=date('d.m', (time()+3600*24*-3))?></th>
                    <th class="small_size"><?=date('d.m', (time()+3600*24*-2))?></th>
                    <th class="small_size"><?=date('d.m', (time()+3600*24*-1))?></th>
                    <th class="small_size"><?=date('d.m')?></th>
                    <!--майбутнє (план)-->
                    <th class="small_size"><?=date('d.m')?></th>
                    <th class="small_size"><?=date('d.m', (time()+3600*24*1))?></th>
                    <th class="small_size"><?=date('d.m', (time()+3600*24*2))?></th>
                    <th class="small_size"><?=date('d.m', (time()+3600*24*3))?></th>
                    <th class="small_size"><?=date('d.m', (time()+3600*24*4))?></th>
                    <th class="small_size"><?=date('d.m', (time()+3600*24*5))?></th>
                    <th class="small_size"><?=date('d.m', (time()+3600*24*6))?></th>
                    <th class="small_size"></th>
                    <th class="small_size"></th>
                </tr>
            </thead>

            <?=$table?>

        </table>
    </div>
</div>
<div id="popupmenu" style="display: none">
    <table style="background: #ffffff">
        <thead><tr class="multiple_header_table" style="width: 100px"><th class="middle_size">Вкажіть дату на яку відобразити завдання</th></tr></thead>
        <tr>
            <td class="middle_size" onclick="setdate();" style="cursor: pointer">1</td>
        </tr>
        <tr>
            <td class="middle_size" onclick="setdate();" style="cursor: pointer">2</td>
        </tr>
    </table>
</div>
<script>

    $(document).ready(function(){
        $('#reference_body').attr('height', window.innerHeight - 370);
        $('#reference_body').width($('#reference_body').width()+15);
        $('#popupmenu').offset({top:550, left:-250});
        var Width = $(".WidthScroll").width();
        var Top = $(".WidthScroll").height();
        $("#sent_task").offset({top:Top+180, left:-Width+5});
        SetTheadColumnWidth();
    })
    function ShowActionsByUsers(typeaction, alias){
        console.log(typeaction);

        var btn = $('#btnLn'+typeaction+alias+'<?=$user->subdiv_id?>');
//        console.log(btn);
//        return;
        var tr_item = btn.parent().parent();
        var img = $('#imgLn'+typeaction+alias+'<?=$user->subdiv_id?>');
                console.log('#imgLn'+typeaction+alias+'<?=$user->subdiv_id?>', img);

//        return;

//        var img = btn.getElementsByTagName('img')[0];
        var show = img.attr('src').substr(img.attr('src').length-('1downarrow.png').length) == '1downarrow.png';
        if(show)
            img.attr('src', img.attr('src').substr(0, img.attr('src').length-('1downarrow.png').length)+'1uparrow.png');
        else
            img.attr('src', img.attr('src').substr(0, img.attr('src').length-('1uparrow.png').length)+'1downarrow.png');
        var code = '';
        var responding = '';
        var subdiv_id = '';
        switch(typeaction){
            case 'AllTask':{
                code = 'all';
                responding='';
            }break;
            case 'AC_GLOBAL':{
                code = "'AC_GLOBAL'";
                responding='';
            }break;
            case 'AC_CURRENT':{
                code = "'AC_CURRENT'";
                responding='';
            }break;
            case 'AC_CUST':{
                code = "'AC_CUST'";
                responding='';
            }break;
            case 'DirecorsAllTask':{
                code = 'all';
                responding=10;
            }break;

        }
        if(show) {
//            console.log('<?=$user->subdiv_id?>');
            if($('.'+typeaction).length == 0) {
//                var tr_item = btn.parentNode.parentNode;
//                console.log(tr_item.attr('class'));
//                return;
                var className = tr_item.attr('class');
                className = className.replace('impair ', '');
                className = className.replace('pair ', '');
                className = $.trim(className);
                var link = '/dolibarr/htdocs/responsibility/gen_dir/day_plan.php?action=getUsersTask&code='+code+'&responding='+alias+'&classname='+className+' '+ '<?=$user->subdiv_id?>'+'&subdiv_id='+'<?=$user->subdiv_id?>';
//                console.log(link);
//                return;
                $.ajax({
                    url: link,
                    cache: false,
                    success: function (html) {
                        html = html.replace(/ <?=$user->subdiv_id?>/g, '');
                        html = html.replace(/userlist/g, 'userlist '+typeaction);
//                        console.log(html);
                        tr_item = document.getElementById(tr_item.attr('id'));
                        tr_item.insertAdjacentHTML('afterend', html);
                    }
                })
            }else{
//                var tr_item = document.getElementsByClassName('<?=$user->subdiv_id?>');
//                for(var i=0; i<tr_item.length; i++) {
//                    console.log(tr_item[i].className.substr(tr_item[i].className.length-'<?=$user->subdiv_id?>'.length), '<?=$user->subdiv_id?>');
//                    if(tr_item[i].className.substr(tr_item[i].className.length-'<?=$user->subdiv_id?>'.length) == '<?=$user->subdiv_id?>' || tr_item[i].className.substr(tr_item[i].className.length-('<?=$user->subdiv_id?>'+' userlist').length) == '<?=$user->subdiv_id?>'+' userlist')
//                        $('#' + tr_item[i].'<?=$user->subdiv_id?>').show();
//                }
                $('.'+typeaction).show();
            }
        }else{
            $('.'+typeaction).hide();
            img.src = '/dolibarr/htdocs/theme/eldy/img/1downarrow.png';
        }
    }

    function ShowLinectiveTask(typeaction){
//        console.log(typeaction);
//        return;
        var btn = document.getElementById('btn'+typeaction);
        var img = document.getElementById('img'+typeaction);
        var show = img.src.substr(img.src.length-('1downarrow.png').length) == '1downarrow.png';
        if(show)
            img.src = img.src.substr(0, img.src.length-('1downarrow.png').length)+'1uparrow.png';
        else
            img.src = img.src.substr(0, img.src.length-('1uparrow.png').length)+'1downarrow.png';
        var code = '';
        var responding = '';
        var subdiv_id = '';
        switch(typeaction){
            case 'AllTask':{
                code = 'all';
                responding='';
            }break;
            case 'AC_GLOBAL':{
                code = "'AC_GLOBAL'";
                responding='';
            }break;
            case 'AC_CURRENT':{
                code = "'AC_CURRENT'";
                responding='';
            }break;
            case 'AC_CUST':{
                code = "'AC_CUST'";
                responding='';
            }break;
            case 'DirecorsAllTask':{
                code = 'all';
                responding=10;
            }break;

        }
        var tr_item = btn.parentNode.parentNode;

        if(show) {
            console.log('.'+typeaction+'<?=$user->subdiv_id?>');
            if($('.lineactive').length == 0) {
                var className = tr_item.className;
                className = className.replace('impair ', '');
                className = className.replace('pair ', '');
                className = $.trim(className);
                var link = '/dolibarr/htdocs/responsibility/gen_dir/day_plan.php?action=getLineActiveTask&code='+code+'&classname='+className+' <?=$user->subdiv_id?>&responding='+responding+'&subdiv_id=<?=$user->subdiv_id?>';
//                console.log(link);
//                return;
                $.ajax({
                    url: link,
                    cache: false,
                    success: function (html) {
                    html = html.replace(/<?=$user->subdiv_id?>, /g, '');

//                        console.log(html);
                        tr_item.insertAdjacentHTML('afterend', html);
                    }
                })
            }else{
//                var tr_item = document.getElementsByClassName(id);
//                for(var i=0; i<tr_item.length; i++) {
//                    console.log(tr_item[i].className.substr(tr_item[i].className.length-id.length), id);
//                    if(tr_item[i].className.substr(tr_item[i].className.length-id.length) == id || tr_item[i].className.substr(tr_item[i].className.length-(id+' userlist').length) == id+' userlist')
//                        $('#' + tr_item[i].id).show();
//                }
                $('.lineactive').show();
            }
        }else{
            $('.lineactive').hide();
            for(var i=0; i<tr_item.length; i++) {
                var img = tr_item[i].getElementsByTagName('img');
//                console.log(img.length);
                if(img.length>0)
                    img[0].src = '/dolibarr/htdocs/theme/eldy/img/1downarrow.png';
//                if(tr_item[i].className.substr(tr_item[i].className.length-id.length) != id) {
//                    console.log(tr_item[i].id);
//                    $('#' + tr_item[i].id).hide();
//                }
            }

        }
    }
    function ShowHideTaskByUsers(respon_alias){
        var src = $('#img'+respon_alias.substr('respon_'.length)).attr('src');
        if(src.substr(src.length-'1downarrow.png'.length)=='1downarrow.png') {
            $('#img' + respon_alias.substr('respon_'.length)).attr('src', '/dolibarr/htdocs/theme/eldy/img/1uparrow.png');
            $('tr.'+respon_alias).show();
        }else {
            $('#img' + respon_alias.substr('respon_'.length)).attr('src', '/dolibarr/htdocs/theme/eldy/img/1downarrow.png');
            $('tr.regions').hide();
            $('tr.'+respon_alias).hide();
        }
        if($('tr.'+respon_alias).length == 0){
            $.ajax({
                url:'/dolibarr/htdocs/responsibility/dir_depatment/day_plan.php?action=get_userlist&respon_alias='+respon_alias.substr('respon_'.length),
                cache:false,
                success:function(html){
//                    $('#reference_body').append(html);
                    var btn = document.getElementById('bnt'+respon_alias.substr('respon_'.length));
                    var tr_item = btn.parentNode.parentNode;

                    tr_item.insertAdjacentHTML('afterend', html);
//                    console.log(html);
                }
            })
        }
    }
    function setdate(id){
//        console.log($('#'+id).text());
//        console.log($("#popupmenu").attr('type_action').substr(0, 'current'.length));
        location.href = 'http://'+location.hostname+'/dolibarr/htdocs/hourly_plan.php?idmenu=10420&mainmenu=hourly_plan&leftmenu=&date='+$('#'+id).text();
//        $("#popupmenu").hide();
    }
</script>

