
<script type="text/javascript" src="/dolibarr/htdocs/societe/js/jquery.maskedinput-1.2.2.js"></script>
<div class="address_header">
    <?if($_GET['action']=='useraction' || $_GET['action'] == 'edituseration'){?>
    </br>
    </br>
    <table id="headercontrol" style="background-color: #ffffff">
        <tr>
            <td><b>Контакт</b></td>
            <td><?=getUserName($_REQUEST['id_usr'])?></td>
        </tr>
    </table>
    <?}else{?>
    <table id="headercontrol" style="background-color: #ffffff">
        <tr>
            <td <?=$style?>><b>Категорія контрагента</b></td>
            <td <?=$style?>><?= $societe->getCategoryOfCustomer();?></td>
            <td><b>Заголовок</b></td>
            <td><?=$object->label?></td>
            <td><b>Статус</b></td>
            <td><?=$_REQUEST['actioncode']=='AC_TEL'?$formactions->form_select_callstatus('callstatus', empty($object->callstatus)?2:$object->callstatus):$formactions->form_select_status_action('formaction',$percent,1,'complete');?></td>
        </tr>
        <tr>
            <td <?=$style?>><b>Назва контрагента</b></td>
            <td <?=$style?>><?= $societe->name?></td>
            <td><b>Тип дії</b></td>
            <td><?=$langs->trans($object->type)?></td>
            <td <?=$style?>><b>Запланована</br>дата початку дії</br></td>
            <td <?=$style?>><?=$form->select_date($Actions->datep,'ap',1,1,0,"action",1,1,0,0,'fulldayend').'<span id="ShowFreeTime" onclick="ShowFreeTime('."'ap'".');" title="Переглянути наявність вільного часу" style="vertical-align: middle"><img src="/dolibarr/htdocs/theme/eldy/img/calendar.png"></span>'?>
			    <script>
                    $('select').change(function(e){
                        if($.inArray(e.target.id, ['aphour','apmin','dateNextActionhour','dateNextActionmin'])>=0){
                            var prefix;
                            if(e.target.id.substr(e.target.id.length - 'hour'.length) == 'hour'){
                                prefix = e.target.id.substr(0, e.target.id.length - 'hour'.length);
                            }
                            if(e.target.id.substr(e.target.id.length - 'min'.length) == 'min'){
                                prefix = e.target.id.substr(0, e.target.id.length - 'min'.length);
                            }
                            var param = {
                                action:'validateDataAction',
                                date:($('#'+prefix+'year').val().length == 0?'':$('#'+prefix+'year').val()+'-'+$('#'+prefix+'month').val()+'-'+
                                    $('#'+prefix+'day').val()+' '+$('#'+prefix+'hour').val()+':'+$('#'+prefix+'min').val()),
                                minutes:$('#exec_time_'+prefix).val(),
                                id_usr:"<?=$user->id?>",
                                prioritet:$('#priority').val()
                            }
                            $.ajax({
                                url:'/dolibarr/htdocs/comm/action/card.php',
                                cache:false,
                                data:param,
                                success:function(result){
                                    $('#type').val('w');
                                    if(result == 0){
                                        $('#'+e.target.id).addClass('fielderrorSelBorder');
                                        $('#'+e.target.id).removeClass('validfieldSelBorder');


                                    }else{
                                        $('#'+e.target.id).addClass('validfieldSelBorder');
                                        $('#'+e.target.id).removeClass('fielderrorSelBorder');
                                    }

                                    if(!$('#'+prefix+'hour').hasClass('fielderrorSelBorder')&&
                                        !$('#'+prefix+'min').hasClass('fielderrorSelBorder'))
                                        $('#error').val(0);
                                    else
                                        $('#error').val(1);
                                    $('#newdate').val($('#apyear').val()+'-'+$('#apmonth').val()+'-'+$('#apday').val()+' '+$('#'+prefix+'hour').val()+':'+$('#'+prefix+'min').val());
                                    console.log(result);
                                }
                            })
                        }
                    });
                </script>
            </td>
            <?if(!empty($style)){?>
                <td></td>
                <td></td>
            <?}?>
        </tr>
        <tr>
            <td <?=$style?>><b>Форма правління</b></td>
            <td <?=$style?>><?=$societe->getFormOfGoverment();?></td>
            <td ><b>Контакт</b></td>
            <td ><?=(!empty($object->contactid)||!empty($_GET['socid'])?$form->selectcontacts(empty($_GET['socid']) ? $object->socid : $_GET['socid'], $object->contactid, 'contactid', 1):$Actions->getAssignedUser($_REQUEST["action_id"]))?></td>
            <td <?=$style?> id="PlanTimeTitle"></td>
            <td <?=$style?> id="PlanTimeResult"></td>
            <?if(!empty($style)){?>
                <td></td>
                <td></td>
            <?}?>
        </tr>
    </table>
    <?}?>
</div>

</br></br>
<div  id="ActionList">
    <form id="addaction" action="" method="post">
        <input id="backtopage" type="hidden" value="<?=$_GET['backtopage']?>" name="backtopage">
        <input id="rowid" name="rowid" type="hidden" value="<?=empty($object->resultaction['rowid'])?$object->rowid:$object->resultaction['rowid']?>">
        <input id="actionid" name="actionid" type="hidden" value="<?=$action_id?>">
        <input id="newdate" name="newdate" type="hidden" value="">
        <input id="socid" name="socid" type="hidden" value="<?=isset($_REQUEST['onlyresult'])&&!empty($_REQUEST['onlyresult'])?$object->socid:$_REQUEST['socid']?>">
        <input id="mainmenu" name="mainmenu" type="hidden" value="<?=$_GET['mainmenu']?>">
        <input type="hidden" value="<?=$_GET['actioncode']?>" name="actioncode">
        <input type="hidden" value="<?=$_GET['proposed_id']?>" name="proposed_id">
        <input type="hidden" value="" name="complete" id="complete">
        <input id="action" name="action" type="hidden" value="">
        <input id="changedContactID" name="changedContactID" type="hidden" value="">
        <input type="hidden" name="typeSetOfDate" id="type" value="<?=$_REQUEST['typeSetOfDate']?>">
        <input type="hidden" name="error" id="error" value="<?=$_REQUEST['error']?>">
        <input id="callstatus" name="callstatus" type="hidden" value="<?=empty($object->callstatus)?2:$object->callstatus?>">

        </br>
        <table class="border" style="margin-top: 20px" width="100%">
            <?=$contactlist?>
            <tr>
                <td>
                    &nbsp;&nbsp;&nbsp;<?echo $langs->trans('WhatSaidHim')?></br>
                    <textarea id="said" class="edit_text" name="said" maxlength="255"><?=$said?></textarea>
                </td>
            </tr>
            <tr>
                <td>
                    &nbsp;&nbsp;&nbsp;<?echo $langs->trans('WhatAnswer')?></br>
                    <textarea id="answer" class="edit_text" name="answer" maxlength="255"><?=empty($object->resultaction['answer'])?$object->answer:$object->resultaction['answer']?></textarea>
                </td>
            </tr>
            <tr>
                <td>
                    &nbsp;&nbsp;&nbsp;<?echo $langs->trans('HerArgument')?></br>
                    <textarea id="argument" class="edit_text" name="argument" maxlength="255"><?=empty($object->resultaction['argument'])?$object->argument:$object->resultaction['argument']?></textarea>
                </td>
            </tr>
            <tr>
                <td>
                    &nbsp;&nbsp;&nbsp;<?echo $langs->trans('SaidImportant')?>
                    <textarea id="said_important" class="edit_text" name="said_important" maxlength="255"><?=empty($object->resultaction['said_important'])?$object->said_important:$object->resultaction['said_important']?></textarea>
                </td>
            </tr>
            <tr>
                <td>
                    &nbsp;&nbsp;&nbsp;<?echo $langs->trans('ResultAction')?>
                    <textarea id="result_of_action" class="edit_text" name="result_of_action" maxlength="255"><?=empty($object->resultaction['result_of_action'])?$object->result_of_action:$object->resultaction['result_of_action']?></textarea>
                </td>
            </tr>
            <tr>
                <td>
                    &nbsp;&nbsp;&nbsp;<?echo $langs->trans('WorkBeforeAction')?>
                    <textarea id="work_before_the_next_action" class="edit_text" name="work_before_the_next_action" maxlength="255"><?=empty($object->resultaction['work_before_the_next_action'])?$object->work_before_the_next_action:$object->resultaction['work_before_the_next_action']?></textarea>
                </td>
            </tr>
        </table>
    </form>
    <script>
        $('#addaction').submit(function(e){
            if($('#error').length>0&&$('#error').val()==1){
                alert('Дані на формі містять помилки.');
                return false;
            }
        });
    </script>
    <div align="center">
        <button onclick="save();">Зберегти</button>
        <button onclick="saveandcreate();">Зберегти та запланувати наступну дію</button>
        <button onclick="back();">Відмінити</button>
    </div>
</div>
<style>
    #datepButtonNow{
        display: none;
    }
</style>
<script>
    $('#contactid').change(function(e){
        $('#changedContactID').val($(this).val());
//        console.log();
    })
    function dpChangeDay(id, format){
//        	return;
        console.log(id);
        if(id == "datep"){
            $("#apday").val($("#ap").val().substr(0,2));
            $("#apmonth").val($("#ap").val().substr(3,2));
            $("#apyear").val($("#ap").val().substr(6,4));

            if($("#showform").val()!=0){
            var date = new Date($("#ap").val().substr(6,4), $("#ap").val().substr(3,2), $("#ap").val().substr(0,2));
            var today = new Date();
            if(date>today){
                $("select#aphour").val("00");
                $("select#apmin").val("00");
            }

//                	var Date2 = new Date($("#p2year").val(),
//                						($("#p2month").val().substr(0,1)=="0"?$("#p2month").val().substr(1):$("#p2month").val()),
//                						($("#p2day").val().substr(0,1)=="0"?$("#p2day").val().substr(1):$("#p2day").val()),
//                						($("#p2hour").val().substr(0,1)=="0"?$("#p2hour").val().substr(1):$("#p2hour").val()),
//                						($("#p2min").val().substr(0,1)=="0"?$("#p2min").val().substr(1):$("#p2min").val()),
//                						0);
//					var minute = (Date2.getTime()-Date1.getTime())/ (1000*60);
//					console.log($("#exec_time").val());
//					return;
//                	var link = "http://"+location.hostname+"/dolibarr/htdocs/comm/action/card.php?action=get_freetime&minute="+$("#exec_time").val()+"&date="+$("#apyear").val()+"-"+$("#apmonth").val()+"-"+$("#apday").val()+"&id_usr='.$user->id.'&actioncode="+$("select#actioncode").val();
//            		setTime(link);
            }else{
                $("#showform").val(1);
            }
        }
//            console.log(getParameterByName("action") != "edit", $.cookie("ChangeDate") == "true");
        if(getParameterByName("action") != "edit" || $.cookie("ChangeDate") == "true"){
//				setP2(0);
            $.ajax({
                url:'?action=get_freetime&action_id='+getParameterByName('action_id')+'&id_usr=<?=$user->id?>&date='+$("#ap").val()+" 00:00",
                cache:false,
                success:function(result){
                    var obj_res = JSON.parse(result);
                    $('#aphour').val(obj_res.freetime.substr(obj_res.freetime.length-8,2));
                    $('#apmin').val(obj_res.freetime.substr(obj_res.freetime.length-5,2));
                    $("#aphour").removeClass("fielderrorSelBorder");
                    $("#apmin").removeClass("fielderrorSelBorder");
                    $("#type").val("");
                    $("#error").val(0);

                    var newdate = $('#apyear').val()+'-'+$('#apmonth').val()+'-'+$('#apday').val()+' '+$('#aphour').val()+':'+$('#apmin').val();
//                    alert(newdate);
                    $('#newdate').val(newdate);

//                    $('#PlanTimeTitle').html('<b>Запропонована</br>дата та час початку дії</b>')
//                    $('#PlanTimeResult').empty().html(obj_res.freetime);
//                    $('#newdate').val(obj_res.freetime);
//                    CalcP(obj_res.freetime, obj_res.minute, '<?=$user->id?>');//Розрахунок часу початку дії
                }
            })
        }
    }
    $('textarea').keydown(function(e){
        if(e.keyCode == 9 &&e.target.value.length == 0){
            e.target.value='-';
        }
//        console.log(e.target, e.keyCode);
    })
    jQuery(function($) {
        $.mask.definitions['~']='[+-]';
        $('#date_next_action').mask('99.99.9999');
        $('#mobile_phone1').mask('(999) 999-9999');
        $('#mobile_phone2').mask('(999) 999-9999');
        $('#phoneext').mask("(999) 999-9999? x99999");
        $("#tin").mask("99-9999999");
        $("#ssn").mask("999-99-9999");
        $("#product").mask("a*-999-a999");
        $("#eyescript").mask("~9.99 ~9.99 999");
    });
</script>

<script type="text/javascript">
    $(document).ready(function(){
        $('#said').focus();
        $("#ActionList").width(800);
        $("#addaction").width(800);
        $(".tabBar").width(800);
        $('#apButtonNow').remove();
        $("#event_desc").addClass('tabactive');
        if(getParameterByName('action')=='addonlyresult'){
            $('#answer').text('');
        }else if(getParameterByName('action') == 'useraction'){
            var contactid = '<input type="hidden" name="contactid" value="'+getParameterByName('id_usr')+'">'
            $('#addaction').append(contactid);
        }
    })
    function back(){
        var link = $('#backtopage').val();
        if(link.substr(0,1) == "'" && link.substr(link.length-1,1) == "'")
            link = link.substr(1, link.length-2)
//                console.log(link);
//        return;
//        link = 'http://'+location.hostname+link.substr(1, link.length-2);
        location.href = link;
    }

    function save(){
//        if($('#newdate').val().length>0) {
//            console.log($('#newdate').val());
//            confirm('Увага! Було замінено дату виконання дії, тому після зберігання результатів перемовин не буде встановлено статус "Виконано"');
//        }
        if($('#proposed_id').val() === undefined || confirm('Зберегти інформацію?')) {
            var valid = true;
            if('sale' == '<?=$user->respon_alias?>' || 'sale' == '<?=$user->respon_alias2?>')
                valid=validData();
            console.log(valid);
            if(!valid)
                return;
            var search = location.search.substr(1);
            var param = {};
            search.split('&').forEach(function (item) {
                item = item.split('=');
                param[item[0]] = item[1];
            })
//        console.log(param);
//        return;
            $('#socid').val(param.socid);
            $("#addaction").attr('action', '/dolibarr/htdocs/comm/action/result_action.php');
            if (param.action == 'addonlyresult')
                $("#action").val('addonlyresult');
            else if(param.action == 'useraction' || param.action == 'edituseration')
                $("#action").val('saveuseraction');
            else if (param.onlyresult !== undefined)
                $("#action").val('updateonlyresult');
            else
                $("#action").val('update');
            $('#complete').val($('#valcomplete').val());
//            console.log($("addaction").attr('action'));
            submitResultAction();
//        alert('test');
        }
    }
    function submitResultAction(){
            var actioncode = getParameterByName('actioncode');
            var validcode = ['AC_CURRENT', 'AC_GLOBAL'];
//            console.log($.inArray(actioncode, validcode) != '-1');
//        return;
            if(actioncode!=null && actioncode.length>0 && $.inArray(actioncode, validcode) != '-1') {
                $.ajax({
                    url: '/dolibarr/htdocs/comm/action/result_action.php?action=getTypeNotification&action_id=<?=$_REQUEST["action_id"]?>',
                    cache: false,
                    success: function (result) {
                        var result = JSON.parse(result);
                        if (result['typenotification'] == 'sms' && result['author_id'] != <?=$user->id?>
                        &&
                        confirm('В параметрах дії встановленно вид сповіщення - "відправка смс"\n ' +
                                'Перевірте наявність підключеного телефона та підтвердіть відправку смс')
                        )
                        {
                            var searchSumbol = ['(', ')', '+', ' ', '-'];
                            var number = result['phonenumber'];
                            for (var s = 0; s < searchSumbol.length; s++) {
                                number = number.replace(searchSumbol[s], '');
                            }
//                        console.log('Надано відповідь на поставлену Вами задачу. Перевірте будь ласка.'.length);
                            sendSMS(number, 'Надано відповідь на поставлену Вами задачу. Перевірте будь ласка.', false)
                        }
//                    console.log(result);
                        $("#addaction").submit();
                    }
                })
            }else
                $("#addaction").submit();

    }
    function validData(){
        var text = $('#addaction').find('textarea');
        var valid = true;
        for(var i=0; i<text.length; i++){
            if(text[i].value.length == 0){
                text[i].style.borderColor =  'red';
                if(valid == true) {
                    text[i].focus();
                    valid = false;
                    console.log(text[i], text[i].value);
                }
            }else{
                text[i].style.borderColor =  'rgba(0, 0, 0, 0.3) rgba(0, 0, 0, 0.3) rgba(0, 0, 0, 0.2)';
            }
        }
        return valid;
    }
    function saveandcreate(){
//        if($('#newdate').val().length>0) {
//            confirm('Увага! Було замінено дату виконання дії, тому після зберігання результатів перемовин не буде встановлено статус "Виконано"');
//        }
        var valid = true;
        if('sale' == '<?=$user->respon_alias?>' || 'sale' == '<?=$user->respon_alias2?>')
            valid=validData();
        if(!valid)
            return;
        var search = location.search.substr(1);
        var param = {};
        search.split('&').forEach(function(item){
            item = item.split('=');
            param[item[0]]=item[1];
        })

        $('#complete').val($('#valcomplete').val());

        $("#addaction").attr('action', '/dolibarr/htdocs/comm/action/result_action.php');
        if(param.action == 'addonlyresult')
            $("#action").val('addonlyresult_and_create');
        else if(param.action == 'useraction')
            $("#action").val('saveuseraction_and_create');
        else if(param.onlyresult !== undefined)
            $("#action").val('updateonlyresult_and_create');
        else
            $("#action").val('update_and_create');
        submitResultAction();
    }
//    function loadcontactlist(){
//        $('select#contactlist').find('option').remove();
////        console.log('/dolibarr/htdocs/responsibility/sale/action.php?action=loadcontactlist&contactid='+$('select#contact').val());
//        $.ajax({
//            url: '/dolibarr/htdocs/responsibility/sale/action.php?action=loadcontactlist&contactid='+$('select#contact').val(),
//            cache: false,
//            success: function (html) {
////                console.log(html);
//                $('select#contactlist').append(html);
//
//            }
//        });
//    }
    $.ajax({

    })

</script>
<style>
    #ActionList{
        padding-top: 60px;
    }
</style>
