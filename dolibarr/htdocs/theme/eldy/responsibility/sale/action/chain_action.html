
<?if($actioncode != 'AC_CONVERSATION'){?>
<div><a href="<?echo $_SERVER['HTTP_REFERER']?>#<?echo $_REQUEST['socid']?>"><?echo $langs->trans($Task)?></a>  /  <?=$langs->trans($Action)?></div>
</br>
<div  id="customerinfo">
    <table id="headercontrol" style="background-color: #ffffff; width: 750px;">
        <tr>
            <td style="font-size: small"><b>Суть задачі</b></td>
            <?if(!empty($author_id) && $user->id == $author_id){?>
                <td style="font-size: small;"><b>Оцінка виконання</b></td>
            <?}else{?>
                <td style="font-size: small;"><b>Функції</b></td>
            <?}?>
            <?if(!empty($author_id) && $user->id == $author_id){?>
                <td style="font-size: small; width: 250px"><b>Контакти виконавця</b></td>
            <?}else{?>
                <td style="font-size: small; width: 250px"><b>Контакти замовника</b></td>
            <?}?>
            <td style="font-size: small; width: 80px"><b>Строки виконання</b></td>
        </tr>
        <tr>
            <td style="height: 100px; font-size: small"><?=$description?></td>
            <?if(!empty($author_id) && $user->id == $author_id){?>
                <td style="font-size: small;">
                <button style="width: 100%" onclick="setExecutedAction(<?=$_REQUEST['action_id']?>);">&nbspРезультат влаштовує</button>
                </br></br>
                <button  style="width: 100%" onclick="AddResult();">Результат <b>НЕ</b> влаштовує</button>
                </br></br>
                    <?=$addSubAction?>
                </td>
            <?}else{?>
                <td style="font-size: small;"><button  style="width: 100%" onclick="AddResult(<?="'".$subaction->subaction."'"?>);">Додати результат дії</button>
                </br></br>
                    <?=$addSubAction?>
                </td>
            <?}?>
            <td style="font-size: small; vertical-align: top"><?=$contactdata?></td>
            <td style="font-size: small; vertical-align: top"><?=$deadline?></td>
        </tr>
    </table>
</div>
</br>
<?}else{?>
<div><a href="<?echo $_SERVER['HTTP_REFERER']?>#<?echo $_REQUEST['socid']?>"><?echo $langs->trans($Task)?></a>  /  <?=$langs->trans($Action)?></div>
</br>
<div  id="customerinfo">
    <table id="headercontrol" style="background-color: #ffffff; width: 750px;">
        <tr>
            <td style="font-size: small"><b>Суть задачі</b></td>
            <?if(!empty($author_id) && $user->id == $author_id){?>
                <td style="font-size: small;"><b>Оцінка виконання</b></td>
            <?}else{?>
                <td style="font-size: small;"><b>Функції</b></td>
            <?}?>
            <?if(!empty($author_id) && $user->id == $author_id){?>
                <td style="font-size: small; width: 250px"><b>Контакти виконавця</b></td>
            <?}else{?>
                <td style="font-size: small; width: 250px"><b>Контакти замовника</b></td>
            <?}?>
            <td style="font-size: small; width: 80px"><b>Строки виконання</b></td>
        </tr>
        <tr>
            <td style="height: 100px; font-size: small"><?=$description?></td>
            <?if(!empty($author_id) && $user->id == $author_id){?>
                <td style="font-size: small;">
                <button  style="width: 100%" onclick="AddResult();">Додати результат перемовин</button>
                <button  style="width: 100%" onclick="DelAction(getParameterByName('action_id'));">Видалити дію</button>

                </td>
            <?}?>
            <td style="font-size: small; vertical-align: top"><?=$contactdata?></td>
            <td style="font-size: small; vertical-align: top"><?=$deadline?></td>
        </tr>
    </table>
</div>
<?}?>
<div>
    <table id="actions">
        <thead>
        <tr class="header_table">
            <!--<th style="width: 80px" class="middle_size">Дата і дії</th>-->
            <th style="width: 80px" class="middle_size">Дата і час внесення</th>
            <th style="width: 100px" class="middle_size">Хто від нас вносив</th>
            <th style="width: 80px" class="middle_size">Контакт</th>
            <th style="width: 50px" class="middle_size">Вид дій</th>
            <th style="width: 80px" class="middle_size">Що йому озвучили</th>
            <th style="width: 80px" class="middle_size">Що він відповів</th>
            <th style="width: 80px" class="middle_size">Чим аргументував</th>
            <th style="width: 80px" class="middle_size">Що важливого сказав</th>
            <th style="width: 80px" class="middle_size">Результат дій (резюме переговорника)</th>
            <th style="width: 80px" class="middle_size">Робота до/на наступних дій</th>
            <th style="width: 80px" class="middle_size">Дата наст.дій</th>
            <th style="width: 80px" class="middle_size">Робота до/на наступних дій (завдання наставника)</th>
            <th style="width: 80px" class="middle_size">Запропонована дата виконання наставником</th>
            <th class="small_size" width="50px" rowspan="2">Статус завдання</th>
            <th style="width: 20px" class="middle_size"></th>
        </tr>
        </thead>
        <!--<tbody id="reference_body">-->
        <?echo $actiontabe?>
        <!--</tbody>-->
    </table>
</div>
<!--<form id="addaction" action="/dolibarr/htdocs/comm/action/card.php" method="post">-->
    <!--<input type="hidden" name="backtopage" value="'<?=$_SERVER['REQUEST_URI']?>'">-->
    <!--<input type="hidden" name="action" value="create" id="edit_action">-->
    <!--<input type="hidden" name="mainmenu" value="area">-->
    <!--<input type="hidden" value="<?=$_GET['socid']?>" name="socid">-->
    <!--<input type="hidden" name="id" value="" id="action_id">-->
<!--</form>-->
<form id="redirect" action="/dolibarr/htdocs/comm/action/result_action.php" method="get">
    <input type="hidden" name="backtopage" value="'<?=$_SERVER['REQUEST_URI']?>'">
    <input type="hidden" name="action_id" value="" id="action_id">
    <input type="hidden" name="answer_id" value="" id="answer_id">
    <input type="hidden" name="mainmenu" value="<?=$_REQUEST['mainmenu']?>">
    <input type="hidden" value="<?=$actioncode?>" id="redirect_actioncode" name="actioncode">
    <input type="hidden" name="action" value="edit" id="edit_action">
</form>
<div id="confirm-container" style="display: none; position: absolute; left: 150px; top: 150px; z-index: 10;">
    <div id="question" style="font-weight: bold"></div>
    <label><input id="forAllGroup" type="checkbox" value="false">  Застосувати до всієї групи завдань</label>
    <br>
    <input type="submit" value="&nbsp;&nbsp;&nbsp;Ок&nbsp;&nbsp;&nbsp;" onclick="setConfirm();">
    <input type="button" name="cancel" onclick="CloseConfirmForm();" value="Відмина">
</div>
<style>
    #reference_body td{
        font-size: 12px;
    }
    #prev_action{
        width: 65%;
        height: 90px;
    }
    #confirm-container {
        display: inline-block;
        padding: 5px 5px 5px 5px;
        border: 1px solid black;
        background: white;
        vertical-align: middle;
        border-radius: 5px;
    }
</style>
<script>
    function setConfirm() {
        $('#confirm-container').hide();
        var param = {
            "action":"getActionStatus",
            "action_id":getParameterByName('action_id'),
            "forAllGroup":$('#forAllGroup').attr('checked')=='checked'
            }
        $.ajax({
            url:'/dolibarr/htdocs/comm/action/card.php',
            data:param,
            cashe:false,
            success:function(result) {
                if (result == '100') {
                    alert('Вже встановлено статус дії "Прийнято"');
                    window.close();
                    return;
                }
                var link = "http://" + location.hostname + "/dolibarr/htdocs/comm/action/card.php?action=confirm_exec&rowid="+ getParameterByName('action_id')+'&forAllGroup='+($('#forAllGroup').attr('checked')=='checked'?'true':'false');
//                console.log(link);
//                return;
                $.ajax({
                    url: link,
                    cache: false,
                    success: function (html) {
//                        window.close();
                        console.log(html, 'confirm_exec');
                        var mainmenu = getParameterByName('mainmenu');
                        return;
                        if (mainmenu == 'global_task')
                            location.href = '/dolibarr/htdocs/global_plan.php?idmenu=10421&mainmenu=global_task&leftmenu=';
                        else if (mainmenu == 'current_task')
                            location.href = '/dolibarr/htdocs/current_plan.php?idmenu=10423&mainmenu=current_task&leftmenu=';
                    }
                })
            }
        })
        $('#forAllGroup').val(false);
    }
    function CloseConfirmForm() {
        $('#confirm-container').hide();
        $('#forAllGroup').val(false);
        return {"result":"false"};
    }
    $(document).ready(function (e) {
        $('#confirm-container').hide();
        var param = {
            action: 'get_subactiontype',
            action_id:'<?=$_REQUEST['action_id']?>'
        }
        $.ajax({
            data:param,
            cache:false,
            type:'post',
            success: function (json) {
                if(json.length == 0)
                    return;
//                {
//                    alert('Оновіть будь ласка сторінку');
//                    return;
//                }
                console.log(json);
                var res = $.parseJSON(json);

                switch (res['subaction']) {
                    default:
                    {
                        createNewForm('popupmenu', 'previewmail');
                        $('#previewmail').empty().html(res['body']);
                        $('#previewmail').css('top', '150px');
                        $('#previewmail').css('left', 'center');
                        $('#previewmail').css('width', 'auto');
                        $('#previewmail').css('height', 'auto');
                        $('#previewmail').css('background', 'white');
                        $('#previewmail').css('overflow-y', 'auto');
                        $('#previewmail').css('max-width', $(window).width()*.7);
                        $('#previewmail').css('max-height', $(window).height()*.7);
                        $('#previewmail').show();
//                        console.log($('#previewmail').width());
                        $('#closePrevDiv').width($('#previewmail').width());
                    }break;
                }
            }
            
        })
    })
    function ClosePreviewMail() {
        $('#previewmail').remove();
    }
    function DelAction(rowid){
        if(confirm('Видалити дію?')) {
            var link = '/dolibarr/htdocs/comm/action/card.php?action=delete_action&rowid=' + rowid;
            $.ajax({
                url: link,
                cache: false,
                success: function (html) {
                    if (html == 1) {
                        history.back();
                    }else
                        console.log('помилка ', html, link);
                }
            })
        }
    }
    $(window).keypress(function(event) {
        if(event.keyCode == 27 && event.target.tagName == 'TEXTAREA')
            $('#'+event.target.id).remove();
        if(event.ctrlKey && event.keyCode == 13 && event.target.tagName == 'TEXTAREA'){

           if(true){
               var param = {
                   rowid:$('#'+event.target.id).attr('rowid'),
                   fieldname:event.target.id,
                   action:'setMentorJob',
                   value:$('#'+event.target.id).val()
               }
               $.ajax({
                   url:'',
                   data:param,
                   cashe:false,
                   type: 'post',
                   success:function(result){
                    if(result == '1')
                        console.log('successfule change');
                   }
               })
               $('td#'+$('#'+event.target.id).attr('rowid')+event.target.id).html($('#'+event.target.id).val());
               $('#'+event.target.id).remove();
           }
//           console.log($('#'+event.target.id).attr('rowid'));
           return;
       }
   });
    function setDateMentor(){
        alert('test');
    }
    function Confirmation(action_id){
        ConfirmExec(action_id);
//        location.href = location.href;
    }



    $(function(){
        $('textarea#work_before_the_next_action_mentor').mouseout(function(e){
                console.log('test');
            $('textarea#work_before_the_next_action_mentor').hide();
        })
        $('td').click(function(e){
            if($(this).attr('id') === undefined) {
                console.log('empty item');
                return;
            }
            var validID = ['work_before_the_next_action_mentor', 'date_next_action_mentor'];
            var colName = $(this).attr('id').substr($(this).attr('rowid').length);
            console.log('<?=$accessMentor?>',$.inArray(colName,validID));
            if($.inArray(colName,validID)>=0 && '<?=$accessMentor?>' == '0') {
                console.log('access denied');
                return;
            }
            console.log($.inArray(colName,validID)<0,$('#'+e.target.id).find('input').length>0);

            if($('#'+e.target.id).find('input').length>0){
                var input = $('#'+e.target.id).find('input');
                var html = '<textarea id="fulltext"  style="width: 350px;height: 150px">'+input.val()+'</textarea>';

                createNewForm('popupmenu','fulltext_form')
//                $('#preview').css('width', 350);
//                $('#preview').css('height',250);
                $('#fulltext_form').empty().html(html);

                $('#fulltext_form').show();
                $('#fulltext_form').offset({
                    top: $('#' + e.target.id).offset().top - 30,
                    left: $('#' + e.target.id).offset().left - 50
                });
                $('#fulltext_form').attr('TitleProposed', 1);
//                $('#fulltext').focus();
                $('#fulltext').mouseout(function(e){
                    $(this).remove();
                })
                return;
            }

//            console.log($.inArray(colName,validID));
            if($.inArray(colName,validID)>=0){
//                            console.log('<?=$accessMentor?>');
                if(colName == 'date_next_action_mentor'){
                    $(function(){
                        var dtDate = $('#'+e.target.id).text();
                        var html = '<input type="text" id="input'+e.target.id+'" value="'+dtDate+'" rowid="'+$('#'+e.target.id).attr('rowid')+'" name="'+e.target.id+'" onmouseover="hidefield('+"'input"+e.target.id+"'"+');">';
                        $('td#'+e.target.id).empty().html(html);
                        showDP('/dolibarr/htdocs/core/', 'input'+e.target.id,'dd/MM/yyyy','uk_UA');
                        $('#input'+e.target.id).change(function(event){
                                var param = {
                                    rowid:$('#'+event.target.id).attr('rowid'),
                                    fieldname:event.target.id.substr('input'.length+$('#'+event.target.id).attr('rowid').length),
                                    action:'setMentorDate',
                                    value:$('#'+event.target.id).val()
                                }
                                $('td#'+event.target.id.substr('input'.length)).empty().html(param.value);
                                $('#'+event.target.id).remove();
                                $.ajax({
                                   url:'',
                                   data:param,
                                   cashe:false,
                                   type: 'post',
                                   success:function(result){
                                    if(result == '1')
                                        $('#'+event.target.id).remove();
                                        console.log('successfule change');
                                   }
                                })
//                            	console.log($('#'+event.target.id).val());
                        })
                    })
                    return;
                }

                var html = '<textarea id="'+colName+'" rowid="'+$('#' + e.target.id).attr('rowid')+'" title="Для збереження даних натисніть Ctrl+Enter, для закриття Ecs">'+$(this).text()+'</textarea>';

                createNewForm('popupmenu',colName+'editor')
                $('#'+colName+'editor').css('width', 250);
                //$('#popupmenu').css('height',250);
                $('#'+colName+'editor').empty().html(html);
                $('#'+colName+'editor').attr('rowid', $('#' + e.target.id).attr('rowid'))

                $('#'+colName+'editor').show();
                $('#'+colName+'editor').offset({
                    top: $('#' + e.target.id).offset().top - 30,
                    left: $('#' + e.target.id).offset().left - 50
                });
                $('#'+colName+'editor').attr('TitleProposed', 1);
                $('#'+colName).focus();
            }


//            if($(this).attr('id').substr(0, 4)!='calc')
//                return;
//            //ловим элемент, по которому кликнули
//            var t = e.target || e.srcElement; //получаем название тега
//            var elm_name = t.tagName.toLowerCase(); //если это инпут - ничего не делаем
//            if(elm_name == 'input') {return false;}
//
//            var val = $(this).html();
//            var field = '<input type="text" id="edit" value="'+val+'" size=2/>';
//            $(this).empty().append(field); //устанавливаем фокус на свеженарисованное поле
//            $('#edit').focus();
//            $('#edit').select();
//            $('#edit').blur(function() { //устанавливаем обработчик
//                var val = $(this).val(); //получаем то, что в поле находится
//                //находим ячейку, опустошаем, вставляем значение из поля
//                $(this).parent().empty().html(val);
//                var theme_id, socid;
//                for(var i = 5; i< e.target.id.length; i++){
//                    if(e.target.id.substr(i,1)=="_"){
////                        console.log(i);
//                        theme_id = e.target.id.substr(5,i-5);
//                        socid    = e.target.id.substr(i+1);
//                    }
//                }
////                console.log(theme_id, socid);
//                var td = $('#'+e.target.id).parent();
//                $.ajax({
//                    url:'/dolibarr/htdocs/calculator/index.php?action=set&socid='+socid+'&theme_id='+theme_id+'&val='+val+'&id_usr=<?=$user->id?>',
//                    cache:false,
//                    success:function(html){
//
//                    }
//                })
//            });
        })
    })
    function hidefield(field){
        if($('.dp').length == 0) {
            var value = $('#' + field).val();
            $('#' + field).parent().empty().html(value);
//            $('#' + field).remove();
        }
    }
    function AddResult(subaction){
        $.ajax({
            url:'/dolibarr/htdocs/comm/action/card.php?action=getActionStatus&action_id='+getParameterByName('action_id'),
            cashe:false,
            success:function(result) {
                console.log(result);
                if (result == '100') {
                    alert('Вже встановлено статус дії "Прийнято"');
                    return;
                }
                var link = '/dolibarr/htdocs/comm/action/result_action.php';
                var backtopage = location.pathname+location.search;
                backtopage = backtopage.replace(/\=/g,'%3D')
                backtopage = backtopage.replace(/\?/g,'%3F')
                backtopage = backtopage.replace(/\//g,'%2F')
                backtopage = backtopage.replace(/\&/g,'%26')
                var mainmenu = getParameterByName('mainmenu');
                var actioncode = '';
                if(mainmenu == 'global_task')
                    actioncode='AC_GLOBAL';
                else if(mainmenu == 'current_task')
                    actioncode='AC_CURRENT';
                location.href = link+'?action=addonlyresult&backtopage='+backtopage+'&actioncode='+actioncode+'&action_id='+getParameterByName('action_id')+'&onlyresult=1'+(subaction !== undefined && subaction.length == 0?'':'&subaction='+subaction);
            }
        })
    }
    function setExecutedAction(id){
//        ConfirmExec(id);
//        return;
        ConfirmForm('Установити відмітку про виконання роботи?');
    }
    function DelResultAction(rowid){
        if(confirm('Видалити запис?')) {
            var link = '/dolibarr/htdocs/comm/action/card.php?action=delete_resultaction&rowid=' + rowid;

            $.ajax({
                url: link,
                cache: false,
                success: function (html) {
                    if (html == 1)
                        location.href = location.href;
                    else
                        console.log('помилка ', html, link);
                }
            })
        }
    }
    function ShowHideContactList(object){
        if($('#'+object.attr('id')).text().trim()=='Скрити контакти') {
            $('#' + object.attr('id')).text('Відобразити контакти');
            $('#contactlist').hide();
        }else {
            $('#' + object.attr('id')).text('Скрити контакти');
            $('#contactlist').show();
        }
    }
    function AddAction(){
        $("#actionbuttons").attr('action', '/dolibarr/htdocs/comm/action/card.php');
        console.log($("#actionbuttons"));
    }

</script>