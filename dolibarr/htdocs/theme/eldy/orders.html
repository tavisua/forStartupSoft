<a onclick="close_action();" class='overlay' id='type_action'></a>
 <div class='popup' id='actionform' style='width: 300px;display: none'>
     Оформити:
    <form id="choose_typeaction" action="<?=$_SERVER['REQUEST_URI']?>" method="post">
        <p><input type="radio" name="type_action" value="with_list" id="with_list" checked ><label for="with_list"> товарну потребу зі списку</label></p>
        <p><input type="radio" name="type_action" value="without_list" id="without_list" ><label for="without_list"> товарну потребу без списку</label></p>
        <p><input type="radio" name="type_action" value="internal" id="internal" ><label for="internal"> внутрішню потребу без списку</label></p>
    </form>
    <button onclick='choose_action();'><?=$langs->trans('Choose')?></button>
    <!--<button onclick='close_action();'><?=$langs->trans('Cancel')?></button>-->
        <a class='close' title='Закрыть' href='#close'></a>
 </div>
<div id="savebtn" style="display: none">
    <button style="width: 200px;height: 30px" onclick="showorders();">Відобразити заявку</button>
    <button style="width: 200px;height: 30px" onclick="preparedorders();">Зберегти заявку</button>
</div>
<div id="popupmenu" style="display: none;" class="pair popupmenu" >

    <table style="background: #ffffff; border-collapse: collapse;" id="popup_table" >
    </table>
    <script>
        $(window).click(function (e) {
//            console.log($('#popup_table').attr('order_id'), $('#popup_table').attr('order_id') === undefined);
            if (e.target.id.substr(0, 2) == 'td' && $('#popup_table').attr('order_id') !== undefined) {
                var val = $('#'+e.target.id).text();
//                console.log($(this).attr('id'));
                var field = '<input type="text" id="edit" value="'+val+'" size=4>';
                $('#'+e.target.id).empty().append(field); //устанавливаем фокус на свеженарисованное поле
                $('#edit').focus();
                $('#edit').select();
                $('#edit').blur(function() { //устанавливаем обработчик
                    var val = $(this).val(); //получаем то, что в поле находится
                    //находим ячейку, опустошаем, вставляем значение из поля
                    var product_id = $(this).parent().parent().attr('id').substr(2);
                    $(this).parent().empty().html(val);
                    var tr = $('#popup_table').find('tr');
                    var dSum = 0;
                    var JSON = '{';
                    for(var i = 0; i<tr.length; i++) {
                        if($('#price'+tr[i].id.substr(2)).text().length>0 && $('#td'+tr[i].id.substr(2)).text().length>0)
                            dSum += $('#price'+tr[i].id.substr(2)).text()*$('#td'+tr[i].id.substr(2)).text();
                        if($('#price'+tr[i].id.substr(2)).text().length>0) {
                            if (JSON.length > 1)
                                JSON += ',';
                            JSON += '"' + tr[i].id.substr(2) + '":' + $('#td' + tr[i].id.substr(2)).text();
                        }
                    }
                    JSON+='}';
                    $('#total_price').text('Загалом на суму '+dSum);
                    $.cookie('products', JSON);
//                    console.log(JSON);

                });
            }
        });

    </script>
    <div style="color: #0000FF; font-weight: bold; font-size: 14px; padding: 5px 0px 5px 20px" id="total_price">Загалом на суму </div>
    <div style="text-align: center">
    <button style="width: 150px;height: 30px" onclick="saveorders();">Зберегти заявку</button>
    <button style="width: 150px;height: 30px" onclick="close_registerform();">Закрити</button>
    </div>
</div>
<div id="typicalqueries" style="display: none; height: 80%"  class="pair popupmenu">
    <div style="color: #0000FF; font-weight: bold; font-size: 14px; padding: 5px 0px 5px 20px" id="title_question">Дозвольте задати Вам останні організаційні запитання...</div>
    <form id="questions_form" action="?type_action=save_orders" method="post">
    <input type="hidden" value="" id = "order_id" name="order_id">
    <input type="hidden" value="" id = "products" name="products">
    <input type="hidden" value="<?=$_REQUEST['mainmenu']?>" name="mainmenu">
    <input type="hidden" value="<?=$_REQUEST['idmenu']?>" name="idmenu">
    <table style="background: #ffffff; border-collapse: collapse;" id="questions" >
    </table>
    </form>
    <div style="text-align: center">
    <button style="width: 150px;height: 30px" onclick="saveorders(true);">Зберегти заявку</button>
    <button style="width: 150px;height: 30px" onclick="close_registerform();">Відмінити</button>
    </div>
</div>
<button id="createorderbtn" onclick="createorder();" style="width: 200px;height: 30px">Створити заявку</button>
<table id="orders">
    <thead>
        <tr class="multiple_header_table">
            <th style="width: 60px" class="middle_size">
                Дата створен.
            </th>
            <th style="width: 200px" class="middle_size">
                Клієнт
            </th>
            <th title="Попередня дата обробки" style="width: 60px" class="middle_size">
                Попер. дата оброб.
            </th>
            <th style="width: 80px" class="middle_size">
                Постачальник
            </th>
            <th style="width: 80px" class="middle_size">
                Статус
            </th>
            <th style="width: 60px" class="middle_size">
                Дії
            </th>
        </tr>
    </thead>
    <?=$orders?>
</table>
<input type="hidden" id="choosed_products" value="">

<script>
    $(document).ready(function(){
        if($('table#orders').find('tbody').length == 0){
            $('table#orders').hide();
        }

        if("<?=$_REQUEST['type_action']?>" == 'without_list'){
            $('#groupproducts').css('margin-top', 0);
            console.log('set');
        }
//        console.log();
            if($('#typicalqueries').height()>580)
                $('#typicalqueries').height(580);
            patch_link();
            get_choosed_products();
            $('#first').removeClass("tabpriceactive");
            $('#second').removeClass("tabpriceactive");
            $('#thirth').removeClass("tabpriceactive");
            $('.tabs').remove();
            switch('<?=$_REQUEST["page"]?>'){
                case '1':{
                    $('#first').addClass("tabpriceactive");
                }break;
                case '2':{
                    $('#second').addClass('tabpriceactive');
                }break;
                case '3':{
                    $('#thirth').addClass('tabpriceactive');
                }break;
            }
            var table = $('.WidthScroll');
            if("<?=$_REQUEST['type_action']?>" == 'with_list') {
                $('#savebtn').appendTo($('.tabPage')[0]);
                $('#savebtn').prependTo('.WidthScroll');
                $('#savebtn').show();
                $('#createorderbtn').hide();
                document.getElementsByClassName('multiple_header_table')[0].innerHTML += '<th style="width: 55px" class="middle_size">Потреба</th>';
                $('tbody#products').width(985);
            }


//
//
//
            for(var i = 0; i<$('tbody#products').find('tr').length;i++){
                var tr = $('tbody#products').find('tr')[i];
                tr.innerHTML+='<td id = "td'+tr.id.substr(2)+'" style="width:50px; text-align: center"><input id="Col'+tr.id.substr(2)+'" onblur="setProductCount(Col'+tr.id.substr(2)+');" class="product_count" value="" type="text" size="4"></td>';
            }
//            $('#savebtn').show();
//
    });
    $(window).click(function(){
        if(location.href.substr(strpos(location.href, "#")) == '#close'){
            $('#popupmenu').hide();
        }
    });
    function createorder(){
        location.href = '#type_action';
        $('#actionform').show();

        console.log('test');
    }
    function saveorders(typicalqueries){
        if(typicalqueries === undefined){
            if($.cookie('products') == null){
                var tr = $('#popup_table').find('tr');
                var JSON = '{';
                for(var i = 0; i<tr.length; i++) {
                    if($('#price'+tr[i].id.substr(2)).text().length>0) {
                        if (JSON.length > 1)
                            JSON += ',';
                        JSON += '"' + tr[i].id.substr(2) + '":' + $('#td' + tr[i].id.substr(2)).text();
                    }
                }
                JSON+='}';
                $.cookie('products', JSON);
            }
            if($('#popup_table').attr('order_id') !== undefined) {
                var order_id = $('#questions_form').find('input#order_id');
                order_id.val($('#popup_table').attr('order_id'))
                var products = $('#questions_form').find('input#products');
                products.val($.cookie('products'));
//                console.log(order_id.val());
            }
            preparedorders();
//            console.log();
        }else {
            var Query = '';
            if($('#popup_table').attr('order_id') === undefined)
                Query = 'Зберегти активну заявку?';
            else
                Query = 'Зберегти заявку?';
            if (confirm(Query)) {
                $('#questions_form').submit();
            }
        }
    }
    function deleteorder(order_id){
        if(confirm('Видалити заявку?')) {
            $.ajax({
                url: '<?=$_SERVER["PHP_SELF"]?>?type_action=del_query&order_id=' + order_id,
                cashe: false,
                success: function (html) {
                    location.href = '<?$_SERVER["REQUEST_URI"]?>';
                }
            })
        }
    }
    function preparedorders(){
            $('.popupmenu').hide();
            $('#typicalqueries').css('position', "absolute");
            $('#typicalqueries').css("top", '150');
            $('#typicalqueries').css("z-index", '1500000');
            $('#typicalqueries').css("left", (($(window).width() - 458) / 2));
//            location.href = '#login_phone';
            $.ajax({
            url: '<?=$_SERVER["PHP_SELF"]?>?type_action=get_typical_question',
            cashe: false,
            success: function(html){
                $('#questions').html(html);
                }
            })
        $('#typicalqueries').show();
    }
    function showorders(order_id){
//        console.log(order_id);
//        return;
        $.ajax({
            url: '<?=$_SERVER["PHP_SELF"]?>?type_action=showorders&order_id='+order_id,
            cashe: false,
            success: function(html){
                $('#popup_table').html(html);
                var tr = document.getElementById('popup_table').getElementsByTagName('tbody')[0].getElementsByTagName('tr');
                var TotalPrice = 0
                for(var i = 0; i<tr.length; i++){
                    var id = tr[i].id.substr(2);
                    TotalPrice += $('#popup_table').find('#price'+id).html()*$('#popup_table').find('#td'+id).html();
                }
                $('#total_price').html('Загалом на суму '+TotalPrice);
            }
        })
//        console.log('set atribut order_id', parseInt(order_id)!=0);
        if(parseInt(order_id)!=0){
            $('#popup_table').attr('order_id', order_id);
        }
        $('#popupmenu').css('position', "absolute");
        $('#popupmenu').css("top", '150');
        $('#popupmenu').css("z-index", '1500000');
        $('#popupmenu').css("left", (($(window).width() - 458) / 2));
        location.href = '#login_phone';
        $('#popupmenu').show();
    }
    function  get_choosed_products(){
        $.ajax({
            url: '<?=$_SERVER["PHP_SELF"]?>?type_action=get_choosed_product',
            cashe: false,
            success: function(html){
                var result = html;
                var products_id = result.split(';');
                for(var i=0; i<products_id.length-1; i++) {
                    var row = products_id[i].split('=');
                    $('#Col'+row[0]).val(row[1]);
                }
            }
        })
    }
    function patch_link(){
        var groups = document.getElementById('groupproducts');
        if(groups != null) {
            var links = groups.getElementsByTagName('a');
            for (var i = 0; i < links.length; i++) {
                var href = links[i].href;
                links[i].href = href.substr(0, strpos(links[i].href, "#cat")) + '&type_action=<?=$_REQUEST["type_action"]?>&page=<?=$_REQUEST["page"]?>' + links[i].href.substr(strpos(links[i].href, "#cat"));
            }
            href = $('a#first').attr('href');
            $('a#first').attr('href', href.substr(0, strpos(href, "#cat")) + '&type_action=<?=$_REQUEST["type_action"]?>' + href.substr(strpos(href, "#cat")));
            href = $('a#second').attr('href');
            $('a#second').attr('href', href.substr(0, strpos(href, "#cat")) + '&type_action=<?=$_REQUEST["type_action"]?>' + href.substr(strpos(href, "#cat")));
            href = $('a#thirth').attr('href');
            $('a#thirth').attr('href', href.substr(0, strpos(href, "#cat")) + '&type_action=<?=$_REQUEST["type_action"]?>' + href.substr(strpos(href, "#cat")));
        }
    }
    $(window).keydown(function(event){ //ловим событие нажатия клавиши
//        console.log(event.keyCode);
        if(event.keyCode == 13 || event.keyCode == 9) { //если это Enter
            event.target.blur(event);
        }
    });
    function setProductCount(elem){
//        console.log('test', $('#'+elem.id).val());
        $.ajax({
            url: '<?=$_SERVER["PHP_SELF"]?>?type_action=choose_product&product_id='+elem.id.substr(3)+'&count='+$('#'+elem.id).val()+'&id_usr=<?=$user->id?>',
            cashe: false,
            success: function(html){
                console.log('test');
            }
        })

    }
    function close_action(){
        location.href = '#x';
        $('#actionform').hide();
    }
    function choose_product(id){
        var img = $('#img'+id).attr('src');
        var insert = false;
        if(img.substr(img.length-'uncheck.png'.length)=='uncheck.png'){
            insert = true;
            $('#img'+id).attr('src', '/dolibarr/htdocs/theme/eldy/img/check.png');
        }else{
            $('#img'+id).attr('src', '/dolibarr/htdocs/theme/eldy/img/uncheck.png');
        }
        var action = (insert==true?'insert':'delete');

        $.ajax({
            url:'<?=$_SERVER["PHP_SELF"]?>?type_action=choose_product&action='+action+'&product_id='+id,
            cache:false,
            success:function(html){
                console.log(html);
            }
        })
    }
    function choose_action(){
        $('#choose_typeaction').submit();
    }
    function strpos( haystack, needle, offset){ // Find position of first occurrence of a string
        var i = haystack.indexOf( needle, offset ); // returns -1
        return i >= 0 ? i : false;
    }
</script>

<?=$actionform?>

