<div class="tabBar" style="width: 900px;">
    <table style="border-collapse:collapse" class="WidthScroll">
        <tbody id="mailing">
            <tr class="firstpage">
                <td></td>
                <td></td>
                <td colspan="3" style="text-align: center; border-bottom: solid; border-bottom-color: #6C7C8B; border-bottom-width: thin">Кому?</td>
            </tr>
            <tr class="firstpage">
                <td style="text-align: center;">Куди?</td>
                <td rowspan="2">&nbsp;</td>
                <td id="post">Посада</td>
                <td id="or" rowspan="2">чи</td>
                <td id="sphereOfResponsibility">Сфера відповідальності</td>
            </tr>
            <tr class="firstpage">
                <td><?=$user->getAreasList(0, 'areas', 10, '', $_GET['addParam']);?></td>
                <td id="PostList"><?=$user->getContactPostsList('postlist',10,$_GET['addParam']);?></td>
                <td id="ResponsibilityList"><?=$user->getContactResponsibility('responsibility',10,$_GET['addParam']);?></td>
            </tr>
            <tr class="firstpage">
                <td>Кількість землі </td>
                <td></td>
                <td colspan="3">від&nbsp;&nbsp;<input type="text" id="from" name="from" size="4">&nbsp;&nbsp;до&nbsp;&nbsp;<input type="text" id="to" name="to" size="4">&nbsp;&nbsp;га.</td>
            </tr>
            <tr class="firstpage">
                <td colspan="5"><button onclick="nextstep();">Наступний крок</button></td>
            </tr>
        </tbody>
    </table>
    <table>
        <tr class="email" style="display: none">
            <td>Ім'я відправника </td>
            <td colspan="4" style="width: 100%;"><input id="username" name="username" value="<?=$user->lastname.' '.mb_substr($user->firstname, 0,1, 'UTF-8').'.'?>"></td>
        </tr>
        <tr class="email" style="display: none">
            <td>Адреса відправника </td>
            <td colspan="4" style="width: 100%;"><input id="usermail" name="usermail" value="tavis@shtorm.com"></td>
        </tr>
        <tr class="secondpage" style="display: none">
            <td>Повідомлення </td>
            <td colspan="4" style="width: 100%; height: 150px"><textarea style="width: 100%;height: 100%" <?if($_GET['type'] == 'sms'){?>maxlength="69"<?}?> id="message" name="message"></textarea></td>
        </tr>
        <tr class="secondpage" style="display: none">
            <td><button onclick="sendTestMessage();">Тестове повідомлення</button></td>
            <td><button onclick="sendMessage();">Відіслати повідомлення</button></td>
        </tr>
    </table>
</div>
<input type="hidden" id="phones" value="">

<script>
    $(document).ready(function(){
        $('select#areas [value=0]').html('Вибрати всі');
        $('#postlist').prepend($('select#areas [value=0]').clone());
        $('#responsibility').prepend($('select#areas [value=0]').clone());
        $('select').css('width','100%');
//        console.log($('.secondpage').css('display'));
    })
    function sendTestMessage(){
//        console.log(<?=$userphone?>, $('#message').val());
        if('<?=$_REQUEST["type"]?>' == 'sms') {
            sendSMS('<?=$userphone?>', $('#message').val(), true);
        }else if ('<?=$_REQUEST["type"]?>' == 'email'){
            var emails = [];
            var email = {'contact':$('#username').val(), 'email':$('#usermail').val()};
            emails.push(email);
            sendMail(emails, $('#message').val(), true);
        }
    }
    function nextstep(){
        var param = {'areas':$('#areas').val(),
                    'postlist':$('#postlist').val(),
                    'responsibility':$('#responsibility').val(),
                    'from':$('#from').val(),
                    'to':$('#to').val(),
                    'action':'getCustomers',
                    'type':'<?=$_REQUEST["type"]?>',
                    'addParam':'<?=$_REQUEST["addParam"]?>'
                    }
        $.ajax({
            url:'/dolibarr/htdocs/comm/smsSending/card.php',
            data:param,
            cache:false,
            type: 'post',
            success:function(result){
                $('tbody#mailing').prepend(result)
                $('tbody#mailing').css('height','350px');
//                $('#ContactList').html(result);
                $('.firstpage').hide();
                $('.secondpage').show();
                if(getParameterByName('type') == 'email'){
                    $('.email').show();
                }
            }
        })
    }
    function postMessage(lastpack, contactlist, i){
//        return;
        var param = {
            lastpack: lastpack,
            message: $('textarea#message').val(),
            contacts: contactlist,
            type: getParameterByName('type'),
            action: 'mailing'
        }
//        console.log(param);
//        return;
        var link = '';
        if (getParameterByName('type') == 'sms') {
            link = '/dolibarr/htdocs/comm/smsSending/card.php';
        }
//        console.log(link);
//        return;

        $.ajax({
            url: link,
            data: param,
            cache: false,
            type: 'post',
            success: function (result) {
//                var timeInMs = Date.now();
//                console.log(i, timeInMs, lastpack);
                if(lastpack == true) {
//                    if($('#phones').val().length>0)
//                        $('#phones').val($('#phones').val()+';'+result);
//                    else
//                        $('#phones').val(result);
////                    console.log($('#phones').val());
////                    return;
////                    $numbers = result.split(';');
////                    console.log($numbers.length, result, $('#phones').val());
////                    return;
//                                location.href = '/dolibarr/htdocs/responsibility/<?=$user->respon_alias?>/area.php?idmenu=10425&mainmenu=area&leftmenu='

                }
//                else{
//                    if($('#phones').val().length>0)
//                        $('#phones').val($('#phones').val()+';'+result);
//                    else
//                        $('#phones').val(result);
//                    console.log($('#phones').val());
//                }

//                sendSMS(result, $('#message').val(), false);
            }
        })
    }

    function sendMessage(){
        if(confirm('Відправити розсилку?')) {
            $('#phones').val('');
            var contactlist = [];
            var target = [];
            var trList = $('#mailing').find('tr.secondpage');
//            console.log(trList.length);
//            return;
            for (var i = 0; i < trList.length; i++) {
                if (trList[i].id !== undefined && trList[i].id.length > 0) {
                    var td = trList[i].getElementsByTagName('td');
                    contactlist.push({
                        contactID: trList[i].id,
                        socid: $('#' + trList[i].id).attr('socid'),
                        phone: td[td.length - 1].innerHTML
                    });
                    if('<?=$_REQUEST["type"]?>' == 'sms')
                        target.push(td[td.length - 1].innerHTML);
                    else if('<?=$_REQUEST["type"]?>' == 'email')
                        target.push(td[3].innerHTML+'<'+td[td.length - 1].innerHTML+'>');

                }
            }
//            for (var i = 0; i < 400; i++) {
//                    target.push('+380505223977');
//            }
            if('<?=$_REQUEST["type"]?>' == 'sms') {
                target = target.toString();
                target = target.replace(/\+/gi, '');
                target = target.replace(/\(/gi, '');
                target = target.replace(/\)/gi, '');
                target = target.replace(/\-/gi, '');
                target = target.replace(/\,/gi, ';');
                target = target.replace(/ /gi, '');
                sendSMS(target, $('#message').val(), false);
            }else{
                sendMail(target, $('#message').val(), false);
            }
//            getStatusMessage();
//            console.log(messID);

        }
    }
    function getStatusMessage(){
        $.ajax({
            url:'/dolibarr/htdocs/comm/smsSending/card.php?action=getStatus',
            cashe:false,
            success:function(result){
                if(result == 1)
                    location.href = '/dolibarr/htdocs/responsibility/<?=$user->respon_alias?>/area.php?idmenu=10425&mainmenu=area&leftmenu=';
                else {
                    console.log(new Date().getTime());
                    setTimeout(getStatusMessage, 3000);
                }
            }
        })
    }
</script>

<style>
    #post{
        text-align: center;border-left: solid; border-left-color: #6C7C8B; border-left-width: thin;
    }
    #or{
        text-align: center; border-bottom: solid; border-bottom-color: #6C7C8B; border-bottom-width: thin;
    }
    #sphereOfResponsibility{
        text-align: center;border-right: solid; border-right-color: #6C7C8B; border-right-width: thin;
    }
    #PostList{
        border-left: solid; border-left-color: #6C7C8B; border-left-width: thin; border-bottom: solid; border-bottom-color: #6C7C8B; border-bottom-width: thin;
    }
    #ResponsibilityList{
        text-align: center;border-right: solid; border-right-color: #6C7C8B; border-right-width: thin; border-bottom: solid; border-bottom-color: #6C7C8B; border-bottom-width: thin;
    }
</style>